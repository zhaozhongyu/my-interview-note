## css https://github.com/Advanced-Frontend/Daily-Interview-Question/issues/24 https://juejin.cn/post/6844903919353593869

content-visibility允许浏览器只渲染窗口可见的元素, 但是需要主动设置高度, 避免出现滚动条异常.

重绘与回流

- 回流(reflow)：当浏览器发现某个部分发生了点变化影响了布局，需要倒回去重新渲染。reflow 会从`<html>`这个 `root frame` 开始递归往下，依次计算所有的结点几何尺寸和位置。reflow 几乎是无法避免的。现在界面上流行的一些效果，比如树状目录的折叠、展开（实质上是元素的显示与隐藏）等，都将引起浏览器的 reflow。鼠标滑过、点击……只要这些行为引起了页面上某些元素的占位面积、定位方式、边距等属性的变化，都会引起它内部、周围甚至整个页面的重新渲染。通常我们都无法预估浏览器到底会 reflow 哪一部分的代码，它们都彼此相互影响着。

  

当页面布局和几何信息发生变化的时候，就需要回流。

根据改变的范围和程度，渲染树中或大或小的部分需要重新计算，有些改变会触发整个页面的重排，比如，滚动条出现的时候或者修改了根节点。

一个元素的回流可能会导致了其所有子元素以及DOM中紧随其后的节点、祖先节点元素的随后的回流。

  
  

- 重绘(repaint)：改变某个元素的背景色、文字颜色、边框颜色等等不影响它周围或内部布局的属性时，屏幕的一部分要重画，但是元素的几何尺寸没有变。

  

每次Reflow，Repaint后浏览器还需要合并渲染层并输出到屏幕上。所有的这些都会是动画卡顿的原因。

Reflow 的成本比 Repaint 的成本高得多的多。一个结点的 Reflow 很有可能导致子结点，甚至父点以及同级结点的 Reflow 。在一些高性能的电脑上也许还没什么，但是如果 Reflow 发生在手机上，那么这个过程是延慢加载和耗电的。可以在csstrigger上查找某个css属性会触发什么事件。

  
  

### 导致回流的操作

页面首次渲染

浏览器窗口大小发生改变

元素尺寸或位置发生改变

元素内容变化（文字数量或图片大小等等）

元素字体大小变化

添加或者删除可见的DOM元素

激活CSS伪类（例如：:hover）

查询某些属性或调用某些方法

  
  

### 减少回流次数

* 避免使用table布局。

* 尽可能在DOM树的最末端改变class。

* 避免设置多层内联样式。

* 将动画效果应用到position属性为absolute或fixed的元素上。

* 避免使用CSS表达式（例如：calc()）。

* 使用 transform 替代 top

* 使用 visibility 替换 display: none ，因为前者只会引起重绘，后者会引发回流（改变了布局

* 将频繁重绘或者回流的节点设置为图层，图层能够阻止该节点的渲染行为影响别的节点

* css3硬件加速

  

* 避免频繁操作样式，最好一次性重写style属性，或者将样式列表定义为class并一次性更改class属性。

* 避免频繁操作DOM，创建一个documentFragment，在它上面应用所有DOM操作，最后再把它添加到文档中。

* 避免频繁读取会引发回流/重绘的属性，如果确实需要多次使用，就用一个变量缓存起来。

* 对具有复杂动画的元素使用绝对定位，使它脱离文档流，否则会引起父元素及后续元素频繁回流。

* 隐藏元素，应用修改，重新显示

  

### 减小回流代价

> 从之前的介绍可知, 当页面布局和几何信息发生变化的时候，就需要回流。根据改变的范围和程度渲染树中或大或小的部分需要重新计算，有些改变会触发整个页面的重排. 可以理解为浏览器的回流其实是从当前改变的元素位置, 向上判断父元素, 向下判断兄弟节点的影响进而回流.

因此, 如果当前的元素是一个触发了BFC的元素, 就既不会影响到父节点也不会影响到兄弟节点的布局或几何信息. 也就是说, 浏览器会在判断到父元素/兄弟节点的时候就可以中断此元素影响的回流操作.

  

https://developer.mozilla.org/zh-CN/docs/Web/CSS/contain

可以简单的用css contain属性控制.

  
  

### 为什么动画应该用css替代js

用CSS3动画替代JS模拟动画的好处：

1. 不占用JS主线程；

2. 可以利用硬件加速；

3. 浏览器可对动画做优化（元素不可见时不动画减少对FPS影响）

1.  CSS 3D动画在js中无法实现

2. CSS 2D矩阵动画效率高于js利用margin和left,top模拟的矩阵动画

3. CSS3其它常规动画属性的效率均低于js模拟的动画

坏处是：

浏览器对渲染的批量异步化处理让动画难以控制，此时可以用如下代码来强制同步。

  

在JS执行一些昂贵的任务时，main thread繁忙，CSS动画由于使用了compositor thread可以保持流畅

js需要使用requestAnimationFrame() 。在动画的过程中会不断调用js，消耗内存，一段时间之后触发GC，如果GC时间超出frame budget，动画会卡顿。